这篇笔记介绍JS中内存分配及其生命周期、垃圾回收机制等基础知识。

JS作为一门高级的编程语言，遵循垃圾自动回收机制，一般情况下，对于内存的运行机制不需要了解就可以编写可执行的代码。

但内存空间的分配机制、垃圾回收规则、乃至变量的生命周期对浅拷贝深拷贝及原型链、闭包的原理的理解至关重要。

**一般程序的内存生命周期都是三个阶段：**

* 分配需要的内存
* 进行读写，操作内存
* 释放、归还内存空间

偏底层的语言往往需要自行申请、释放内存，而JS等高级语言，内存的管理过程通常是隐形的、自动创建和回收的。

### 一、内存分配

指的是在需要内存空间的时候，系统自动分配。

哪些时候需要内存空间呢？

* 初始化变量，包括：基础变量和引用变量。
* 部分调用函数或对象的方法。

示例如下：

```js
var a = 1;
var arr = [1,2,3];
var func = function (){
    return ...
}
var time = new Date();
var pic = document.getElementById("pic")
```

其中，初始化变量最为常见。通常来说：

* 基础变量（String、Number、Null、Undefined、Boolean）按值访问，存储在内存栈（stack）。
* 引用变量（Object、Array、Function）的引用指针保存在内存栈，实际值保存在内存堆（heap），指针指向对应的堆地址。

用一张图表示：

![](/assets/neicun.png)

JS为何这样处理呢？

栈（stack）上分配的内存系统会自动释放，一般是静态分配内存；

堆（heap）上动态分配内存，而引用变量的空间大小通常不定，常常频繁的修改。

### 二、操作内存空间

使用、修改值的过程实质上就是对分配内存进行读取和写入的操作，读写可能是写入一个变量或属性值，或者传递函数的参数等。

### 三、释放内存

当内存不需要的时候，程序会自动释放内存。

没有使用的内存没有及时释放，就叫做内存泄漏。

内存泄漏会导致内存空间占用越来越大，轻则影响性能，重则导致程序崩溃。

JS中嵌入了“垃圾回收器”，它会跟踪内存的分配和使用，当变量不再被引用，内存空间会自动释放。

通常的方式是：“引用计数算法” 和 “标记清除算法”。

#### “引用计数算法”

核心思想是：对象有没有其他对象引用，零引用则回收。

引擎将内存中所有变量的引用次数“绘制成“一张”引用表“，一个值的引用次数为0，就表示该值不再使用了，既可以释放内存了；如果值不再使用了，引用次数却不为0（比如某些闭包），这部分内存就无法释放，从而导致内存泄漏。

把一个引用类型赋值给一个变量，这个值的引用次数就是1，当给这个变量赋其他值，原来的值引用次数减一。当引用次数为0，就可以在下次垃圾回收器运行的时候是否它的内存空间了。

```js
var a = {a:1};
a = {b:1};
{a:1} 被释放空间

```

#### “标记清除算法”

现代浏览器的通用算法，核心思想是：对象是否可以获得。

这个算法假定设置一个叫做根（root）的对象（在Javascript里，根是全局对象）。垃圾回收器将定期从根开始，找所有从根开始引用的对象，然后找这些对象引用的对象……从根开始，垃圾回收器将找到所有可以获得的对象和收集所有不能获得的对象。

### 四、优化实践

1、对Object，可以加大对已创建对象的重用；实在不用的对象，可以考虑标记可回收。

```js
var obj = {a:1};
obj = null;  // 释放obj的应用，方便回收器对无引用的{a:1}的回收

-------------------------

var obj= function func(){
  var obj = {a:1};
  ...
}
obj();  //将obj放入函数作用域，调用完函数，执行代码块后会主动释放内部变量内存空间

-------------------------

// 对已创建的object注意清除属性，并添加额外属性，当做另一个变量来使用，以节省创建内存空间消耗
var obj = {a:1};
...
obj.wipe = (obj) => {
  for(let i in obj){
    if(obj.hasOwnProperty(i)){
      delete obj(i)
    }
  }
}
obj.b = 10;

```

2、对数组，也可以遵循类似object的处理办法：

```js
var arr = [1,2,3,4];
...
arr.length = 0;  //清空数组项，并复用数组
arr.push(5); 
```

3、对函数，注意三点：

* 尽量不要在函数体内定义全局变量，不方便垃圾回收；
* 通常来说，函数调用执行完毕后，函数内的局部变量的内存空间都将自动销毁；
* 需要重复调用的函数（如定时器、循环调用），建议使用变量表达式定义函数，而不是声明式，已达到空间的重复利用；





