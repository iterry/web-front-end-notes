### 名词定义：

**Client**：客户端，发起请求的主体。

**Origin  Server**：源服务器，负责分发数据源头服务器。

**域名解析**：浏览器域名到ip地址的转换过程。ip地址是网络上表示站点的数字地址，采用域名地址来代替ip地址来表示站点是为了简单好记。

**DNS**：全称Domain Name System，域名解析服务。提供域名解析服务的服务器称为DNS服务器。

**CNAME**：全称Canonical Name，别名记录。

**CDN节点**：也称边缘节点、Cache节点。指的是在提供CDN服务中，非源服务器的网络节点，其作用是将访问资源和数据保存在服务器前端专门Cache设备上，来提高网站的访问速度和效率。

**B/S架构**：即Brower-Server（浏览器-服务器）架构，是对传统的C/S架构的改进。

C/S架构又称为客户端/服务器模式，用户在客户端安装专门的客户端软件，与后端服务器交互。这种架构模式需要特定软件的支持，特别是针对不同系统平台需要单独开发不同版本，加之产品更新换代十分快，代价高，而且很难适应大量用户的同时使用，效率低。

B/S架构下，用户使用浏览器请求，业务逻辑在服务器端实现，减少了发版迭代的麻烦，结合完善的HTTP/HTTPS机制，提供用户高效快捷的网络体验。

### 为什么要使用CDN

举一个简单的例子：技术和交通落后的时候，买火车票只能在火车站售票大厅购买，住在附近的人购买还算方便，但小县城的人买票就很麻烦了，需要风尘仆仆各种舟车劳顿赶到火车站去买票。后来，全国各地各个地方设立了很多火车票代售点，小县城的人也能很方便快速的在家附近买到火车票了，省时省力。

再比如：在淘宝店家购物，店主在浙江温州，你在黑龙江哈尔滨，快递选择圆通只能从温州快递到哈尔滨，起码花上三天；如果你选择京东购物，快递是京东物流，京东根据你的位置选择最近的仓库给你配货投递，你就能当天就收到快递啦。

CDN就可以理解为火车票代售点或者京东的自建仓库，当客户端发起网络请求，CDN会选择最近的边缘节点来请求响应，请求速度和效率就大大提升了。

### CDN的基本原理和功能

在理解CDN的工作原理和架构之前，先来看看传统的B/S请求流程：

![](/assets/8495773a9074121e42e94bde3f8484a3_articlex.jpg)

1. 用户输入网址域名访问网站。
2. 浏览器向DNS服务器请求对域名的解析。
3. DNS服务器如果缓存了该域名的解析结果，直接响应解析请求并返回结果；如果没有缓存解析结果，则以递归方式向整个DNS系统请求解析，得到应答和解析后将解析结果反馈给浏览器。
4. 得到了解析结果（即域名对应的ip地址），浏览器向服务器发起请求。
5. 服务器响应了请求，处理请求和数据，将结果返回到浏览器。

**架设了CDN服务实质上就是在浏览器和服务器之间增加了Cache层，流程如下：**

![](/assets/rrrrrrr.jpg)

1. 用户请求的域名，到达DNS，DNS系统将域名的解析权交给CNAME指向的CDN专门的DNS服务器。
2. CDN的DNS服务器将CDN的全局负载均衡设备ip返回浏览器，浏览器得到ip，发出请求。
3. 全局负载均衡设备依据ip和具体的请求内容，选择一台用户所属区域的区域负载均衡设备，它会为用户选中合适的Cache服务器。**选择依据如下：**
   1. 依据用户ip地址，判断缓存服务器的远近；
   2. 依据请求内容，判断哪些服务器有用户需要的内容；
   3. 查询各个服务器的负载，判断哪些服务器能提供服务能力；
   4. 综合以上选择，最终确定了Cache服务器及其IP地址。
4. 全局均衡设备将ip地址返回，浏览器获取到返回即刻向Cache服务器发起请求。

5. Cache服务器响应了请求，如果有请求资源，立即处理和返回数据；如果没有请求资源，就向上一级缓存服务器请求内容，直至追溯到源服务器拉取到内容再返回客户端。

**用一句话描述就是**：CDN全称为内容分发网络（Content Delivery Network），通过在网络各范围放置缓存服务器构成的智能虚拟网络，让用户就近获取所需资源，加速请求，极大提升用户体验。

### 适用场景

* 包含大量静态资源的站点。
* 视频、音频点播服务。
* 大文件的上传下载。
* 视频直播加速服务（复杂）。
* 较大访问体量的新闻资讯、内容分发类网站。

### 注意要点

* CDN仅对指定的域名及其二级域名提供加速服务，未指定的域名无效果。
* 数据管辖范围有限制或者对用户数据敏感的域名不建议使用。
* ASP、PHP等动态语言生成的页面不被CDN缓存。
* CDN提供的URL推送服务，可以主动刷新或者清除已有的缓存；URL可以是具体的资源路径，也可以是资源目录。

### 扩展：如何清除CDN缓存

前端业务开发常常碰到CDN缓存清除的情况，以下总结针对不同情况的处理方案：

**1、通过CDN提供的清除接口清除。**

优点：快速、适用于单次极少量或不频繁的资源更新。

确定：不适用大量文件更新；非立即生效；移动端设置了资源缓存的页面，如果已经访问过，如果只是清除而不是更新则无效。

**2、为资源添加版本号，修改资源就更新一次版本号。**

优点：同一。

缺点：版本管理麻烦；不适用于大量资源更新。

优化：如果页面使用的模板且支持后端代码注入，版本号可以让后端管理，通过版本diff，智能管理版本：

```
// 引入
<script src="<?php echo js('/a.js'); ?>"></script>

// php为例
<?php
    $global_version = 2015120500;
    function js($path, $version) {
        // 定义一个路径要使用的，默认是全局的
        $path_version = $global_version;
        // 如果版本号参数不为空
        if (!empty($version)) {
            // 如果版本号参数大于全局的则让路径的版本使用该版本
            if ($version > $global_version) {
                $path_version = $version;
            }
        }
        return $path . $path_version;
    }
?php>
```

**3、文件md5重命名**

说明：需要配合自动化构建工具使用。原理是：构建打包时，把css、js资源重新命名，同时替换掉html中的资源名称。

```
// 原资源名称
static/app.a.js

// 打包后
static/app.3jjd923ccd.a.js
```

优点：修改的文件在打包时自动替换配置规则的名称（推荐md5），未修改的不受影响；配置足够完善无后顾之忧。

缺点：配合打包工具，但也不算什么大问题。

